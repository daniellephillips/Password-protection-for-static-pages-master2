<script>
let pdfDoc = null;
let currentPage = 1;
let isLoading = false;

function loadPDF(pdfURL) {
    document.getElementById('pdf-viewer').innerHTML = ''; // Clear previous PDF
    currentPage = 1; // Reset page counter

    pdfjsLib.getDocument(pdfURL).promise.then(pdf => {
        pdfDoc = pdf;
        loadPage(currentPage); // Load first page
    }).catch(error => {
        console.error("Error loading PDF:", error);
        document.getElementById('pdf-viewer').innerHTML = '<p style="color:red;">Failed to load PDF.</p>';
    });

    // Add scroll listener for lazy-loading
    document.getElementById('pdf-viewer').addEventListener("scroll", handleScroll);
}

function loadPage(pageNum) {
    if (!pdfDoc || isLoading || pageNum > pdfDoc.numPages) return;

    isLoading = true; // Prevent multiple requests

    pdfDoc.getPage(pageNum).then(page => {
        let scale = 1.5;
        let viewport = page.getViewport({ scale });

        let canvas = document.createElement("canvas");
        let context = canvas.getContext("2d");
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        document.getElementById('pdf-viewer').appendChild(canvas);

        let renderContext = {
            canvasContext: context,
            viewport: viewport
        };
        page.render(renderContext).promise.then(() => {
            isLoading = false; // Allow next page load
            currentPage++; // Move to next page
        });
    });
}

function handleScroll() {
    let viewer = document.getElementById('pdf-viewer');
    if (viewer.scrollHeight - viewer.scrollTop <= viewer.clientHeight + 50) {
        loadPage(currentPage); // Load next page when user scrolls near bottom
    }
}
</script>
